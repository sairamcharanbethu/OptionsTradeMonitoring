name: Test VPS Connection
on:
  workflow_dispatch:
jobs:
  test-connection:
    runs-on: ubuntu-latest
    steps:
      - name: Validate secrets
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          if [ -z "$VPS_HOST" ]; then echo "VPS_HOST missing" && exit 1; fi
          if [ -z "$VPS_USERNAME" ]; then echo "VPS_USERNAME missing" && exit 1; fi
          if [ -z "$VPS_SSH_KEY" ]; then echo "VPS_SSH_KEY missing" && exit 1; fi
          echo "Secrets present."
      - name: Prepare SSH key
        shell: bash
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        run: |
          KEY_PATH="$RUNNER_TEMP/ssh_key.pem"
          echo "$VPS_SSH_KEY" | sed 's/\\n/\n/g' > "$KEY_PATH"
          chmod 644 "$KEY_PATH"
          echo "KEY_PATH=$KEY_PATH" >> $GITHUB_ENV
      - name: Test SSH connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key_path: ${{ env.KEY_PATH }}
          port: 22
          script: |
            echo "=========================================="
            echo "SSH Connection Successful"
            echo "=========================================="
            hostname
            whoami
            pwd
            echo "Docker:"
            docker --version
            echo "Docker Compose:"
            docker compose version
            echo "Listing /opt:"
            ls -la /srv/ssmedia
            echo "System:"
            uname -a
            echo "Disk:"
            df -h
